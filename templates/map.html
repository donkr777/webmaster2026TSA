{% extends "base.html" %}
{% block content %}
<section class="map-hero">
    <div class="hero-inner">
        <h2 class="hero-title">Explore Lower Merion Township</h2>
        <p class="hero-sub">Discover historic landmarks, community spaces, and local treasures across Montgomery County</p>
        <div class="hero-stats">
            <div class="stat-bubble">
                <span class="stat-number">40+</span>
                <span class="stat-label">Locations</span>
            </div>
            <div class="stat-bubble">
                <span class="stat-number">325+</span>
                <span class="stat-label">Years of History</span>
            </div>
            <div class="stat-bubble">
                <span class="stat-number">12</span>
                <span class="stat-label">Neighborhoods</span>
            </div>
        </div>
    </div>
</section>

<section class="map-controls">
    <div class="container">
        <div class="filter-controls">
            <button class="filter-btn active" data-filter="all">
                <i class="fas fa-layer-group"></i> All Locations
            </button>
            <button class="filter-btn" data-filter="historical">
                <i class="fas fa-landmark"></i> Historical
            </button>
            <button class="filter-btn" data-filter="shopping">
                <i class="fas fa-shopping-bag"></i> Shopping
            </button>
            <button class="filter-btn" data-filter="parks">
                <i class="fas fa-tree"></i> Parks & Nature
            </button>
            <button class="filter-btn" data-filter="education">
                <i class="fas fa-graduation-cap"></i> Education
            </button>
            <button class="filter-btn" data-filter="entertainment">
                <i class="fas fa-theater-masks"></i> Entertainment
            </button>
            <button class="filter-btn" data-filter="community">
                <i class="fas fa-users"></i> Community
            </button>
        </div>
        <div class="search-controls">
            <div class="search-wrapper">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="locationSearch" placeholder="Search historical sites, parks, landmarks...">
                <button class="search-btn" onclick="searchLocations()">Explore</button>
            </div>
            <button class="reset-btn" onclick="resetMap()">
                <i class="fas fa-sync-alt"></i> Reset View
            </button>
        </div>
    </div>
</section>

<section class="interactive-map">
    <div class="container">
        <div class="map-container">
            <!-- Leaflet Map Container -->
            <div class="map-wrapper">
                <div id="map"></div>
                <div class="map-legend">
                    <div class="legend-title">Explore by Category</div>
                    <div class="legend-items">
                        <div class="legend-item" data-category="historical">
                            <div class="legend-color historical"></div>
                            <span>Historical Sites</span>
                        </div>
                        <div class="legend-item" data-category="shopping">
                            <div class="legend-color shopping"></div>
                            <span>Shopping & Dining</span>
                        </div>
                        <div class="legend-item" data-category="parks">
                            <div class="legend-color parks"></div>
                            <span>Parks & Nature</span>
                        </div>
                        <div class="legend-item" data-category="education">
                            <div class="legend-color education"></div>
                            <span>Education</span>
                        </div>
                        <div class="legend-item" data-category="entertainment">
                            <div class="legend-color entertainment"></div>
                            <span>Entertainment</span>
                        </div>
                        <div class="legend-item" data-category="community">
                            <div class="legend-color community"></div>
                            <span>Community</span>
                        </div>
                    </div>
                </div>
                <div class="map-overlay">
                    <div class="overlay-content">
                        <h4>Lower Merion Township</h4>
                        <p>Founded 1713 â€¢ Main Line Community</p>
                    </div>
                </div>
            </div>
            
            <!-- Enhanced Location Info Panel -->
            <div class="location-info-panel">
                <div class="info-header">
                    <h3><i class="fas fa-map-marker-alt"></i> Lower Merion Discoveries</h3>
                    <p>Click any marker to explore our community's rich heritage</p>
                </div>
                <div class="info-content">
                    <div class="default-message" id="defaultMessage">
                        <div class="welcome-animation">
                            <div class="pulse-dot"></div>
                            <h4>Welcome to Lower Merion</h4>
                        </div>
                        <p>Select a location from the map to discover its history and significance in our community. Lower Merion was first settled in 1682 by Welsh Quakers and has evolved into the vibrant Main Line community we know today.</p>
                        
                        <div class="quick-facts">
                            <div class="fact-card">
                                <i class="fas fa-history"></i>
                                <h5>Rich History</h5>
                                <p>From 1695 Quaker meeting houses to Revolutionary War sites</p>
                            </div>
                            <div class="fact-card">
                                <i class="fas fa-university"></i>
                                <h5>Educational Legacy</h5>
                                <p>Home to prestigious colleges and historic schools</p>
                            </div>
                            <div class="fact-card">
                                <i class="fas fa-leaf"></i>
                                <h5>Natural Beauty</h5>
                                <p>Parks, trails, and preserved natural spaces</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="location-details" id="locationDetails" style="display: none;">
                        <div class="location-header">
                            <h4 id="locationTitle"></h4>
                            <div class="era-badge" id="eraBadge"></div>
                        </div>
                        
                        <div class="location-meta">
                            <span id="locationCategory" class="category-tag"></span>
                            <span id="locationNeighborhood" class="neighborhood-tag"></span>
                            <span id="locationSignificance" class="significance-tag"></span>
                        </div>
                        
                        <div class="description-section">
                            <h5><i class="fas fa-info-circle"></i> About</h5>
                            <p id="locationDescription"></p>
                        </div>
                        
                        <div class="history-section">
                            <h5><i class="fas fa-book"></i> Historical Significance</h5>
                            <p id="locationHistory"></p>
                        </div>
                        
                        <div class="location-actions">
                            <a id="openInMaps" class="btn btn-primary" target="_blank" rel="noopener">
                                <i class="fas fa-external-link-alt"></i> Open in Google Maps
                            </a>
                            <button class="btn btn-secondary" onclick="shareLocation()">
                                <i class="fas fa-share"></i> Share Location
                            </button>
                        </div>
                        
                        <div class="fun-fact" id="funFact">
                            <i class="fas fa-lightbulb"></i>
                            <span id="funFactText"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<section class="neighborhoods-section">
    <div class="container">
        <h3>Explore by Neighborhood</h3>
        <div class="neighborhoods-grid">
            <div class="neighborhood-card" data-neighborhood="ardmore">
                <h4>Ardmore</h4>
                <p>Shopping, dining, and entertainment hub</p>
                <span class="location-count">6 locations</span>
            </div>
            <div class="neighborhood-card" data-neighborhood="bryn-mawr">
                <h4>Bryn Mawr</h4>
                <p>Education and historic sites</p>
                <span class="location-count">5 locations</span>
            </div>
            <div class="neighborhood-card" data-neighborhood="gladwyne">
                <h4>Gladwyne</h4>
                <p>Parks and historic estates</p>
                <span class="location-count">7 locations</span>
            </div>
            <div class="neighborhood-card" data-neighborhood="haverford">
                <h4>Haverford</h4>
                <p>College campus and sports</p>
                <span class="location-count">4 locations</span>
            </div>
        </div>
    </div>
</section>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<!-- Leaflet MarkerCluster CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
/* Enhanced Animations and Aesthetics */
.map-hero {
    background: linear-gradient(135deg, var(--maroon) 0%, #8B2252 100%);
    color: var(--white);
    padding: 80px 0;
    text-align: center;
    position: relative;
    overflow: hidden;
}

.map-hero::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="1"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
    animation: float 20s infinite linear;
}

@keyframes float {
    0% { transform: translate(0, 0); }
    100% { transform: translate(-10px, -10px); }
}

.hero-stats {
    display: flex;
    justify-content: center;
    gap: 30px;
    margin-top: 30px;
    flex-wrap: wrap;
}

.stat-bubble {
    background: rgba(255,255,255,0.2);
    padding: 20px;
    border-radius: 50%;
    width: 100px;
    height: 100px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.3);
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

.stat-number {
    font-size: 1.8rem;
    font-weight: bold;
    display: block;
}

.stat-label {
    font-size: 0.8rem;
    opacity: 0.9;
}

/* Enhanced Map Controls */
.map-controls {
    background: var(--white);
    padding: 30px 0;
    border-bottom: 1px solid #e0e0e0;
    box-shadow: 0 2px 20px rgba(0,0,0,0.1);
}

.filter-controls {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    justify-content: center;
    margin-bottom: 25px;
}

.filter-btn {
    padding: 12px 20px;
    border: 2px solid var(--maroon);
    background: var(--white);
    color: var(--maroon);
    border-radius: 25px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 600;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.filter-btn.active,
.filter-btn:hover {
    background: var(--maroon);
    color: var(--white);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(116, 38, 79, 0.3);
}

.search-controls {
    display: flex;
    justify-content: center;
    gap: 15px;
    align-items: center;
    flex-wrap: wrap;
}

.search-wrapper {
    position: relative;
    display: flex;
    align-items: center;
    background: var(--white);
    border: 2px solid var(--maroon);
    border-radius: 25px;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.search-icon {
    position: absolute;
    left: 15px;
    color: var(--maroon);
    z-index: 2;
}

#locationSearch {
    padding: 12px 20px 12px 45px;
    border: none;
    width: 300px;
    font-size: 14px;
    background: transparent;
}

#locationSearch:focus {
    outline: none;
}

.search-btn, .reset-btn {
    padding: 12px 24px;
    border: none;
    border-radius: 25px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
}

.search-btn {
    background: var(--maroon);
    color: var(--white);
    margin: 3px;
}

.reset-btn {
    background: var(--gold);
    color: var(--maroon);
}

.search-btn:hover {
    background: var(--gold);
    color: var(--maroon);
    transform: translateY(-2px);
}

.reset-btn:hover {
    background: var(--maroon);
    color: var(--white);
    transform: translateY(-2px);
}

/* Enhanced Map Styles */
.map-wrapper {
    position: relative;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 15px 35px rgba(0,0,0,0.1);
    height: 600px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

#map {
    height: 100%;
    width: 100%;
    border-radius: 20px;
}

/* Custom Marker Animations */
.custom-marker {
    background: var(--maroon);
    border: 3px solid white;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 12px;
    transition: all 0.3s ease;
    animation: markerFloat 3s ease-in-out infinite;
}

@keyframes markerFloat {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-5px); }
}

.custom-marker:hover {
    transform: scale(1.3) translateY(-5px);
    z-index: 1000;
}

.marker-historical { background: var(--maroon); animation-delay: 0s; }
.marker-shopping { background: #db2777; animation-delay: 0.1s; }
.marker-parks { background: #16a34a; animation-delay: 0.2s; }
.marker-education { background: #854d0e; animation-delay: 0.3s; }
.marker-entertainment { background: #7c3aed; animation-delay: 0.4s; }
.marker-community { background: #0366d6; animation-delay: 0.5s; }
.marker-sports { background: #dc2626; animation-delay: 0.6s; }
.marker-food_drink { background: #ea580c; animation-delay: 0.7s; }
.marker-nature_center { background: #059669; animation-delay: 0.8s; }

/* Enhanced Info Panel */
.location-info-panel {
    background: var(--white);
    border-radius: 20px;
    box-shadow: 0 15px 35px rgba(0,0,0,0.1);
    padding: 30px;
    height: fit-content;
    position: sticky;
    top: 20px;
    border: 1px solid #e0e0e0;
}

.info-header {
    border-bottom: 3px solid var(--gold);
    padding-bottom: 20px;
    margin-bottom: 25px;
}

.info-header h3 {
    color: var(--maroon);
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.welcome-animation {
    text-align: center;
    margin-bottom: 25px;
}

.pulse-dot {
    width: 12px;
    height: 12px;
    background: var(--gold);
    border-radius: 50%;
    margin: 0 auto 15px;
    animation: pulse 2s infinite;
}

.quick-facts {
    display: grid;
    grid-template-columns: 1fr;
    gap: 15px;
    margin-top: 25px;
}

.fact-card {
    background: var(--light-gray);
    padding: 20px;
    border-radius: 12px;
    border-left: 4px solid var(--maroon);
    transition: all 0.3s ease;
}

.fact-card:hover {
    transform: translateX(5px);
    background: #f8f9fa;
}

.fact-card i {
    color: var(--maroon);
    font-size: 1.5rem;
    margin-bottom: 10px;
}

.fact-card h5 {
    color: var(--maroon);
    margin-bottom: 8px;
}

/* Enhanced Location Details */
.location-header {
    display: flex;
    justify-content: between;
    align-items: flex-start;
    margin-bottom: 20px;
    gap: 15px;
}

.era-badge {
    background: var(--gold);
    color: var(--maroon);
    padding: 6px 12px;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: bold;
    white-space: nowrap;
    flex-shrink: 0;
}

.location-meta {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 25px;
}

.significance-tag {
    background: var(--gold);
    color: var(--maroon);
    padding: 6px 12px;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: bold;
}

.description-section, .history-section {
    margin-bottom: 25px;
}

.description-section h5, .history-section h5 {
    color: var(--maroon);
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.location-actions {
    display: flex;
    gap: 12px;
    margin: 25px 0;
    flex-wrap: wrap;
}

.btn-primary {
    background: var(--maroon);
    color: var(--white);
    padding: 12px 20px;
    border-radius: 25px;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    transition: all 0.3s ease;
    border: none;
    cursor: pointer;
}

.btn-secondary {
    background: transparent;
    color: var(--maroon);
    padding: 12px 20px;
    border-radius: 25px;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    transition: all 0.3s ease;
    border: 2px solid var(--maroon);
    cursor: pointer;
}

.btn-primary:hover, .btn-secondary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

.fun-fact {
    background: linear-gradient(135deg, #fff9c4, #fff59d);
    padding: 15px;
    border-radius: 12px;
    border-left: 4px solid var(--gold);
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 20px;
}

.fun-fact i {
    color: var(--maroon);
    font-size: 1.2rem;
}

/* Neighborhoods Section */
.neighborhoods-section {
    padding: 80px 0;
    background: var(--light-gray);
}

.neighborhoods-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 25px;
    margin-top: 40px;
}

.neighborhood-card {
    background: var(--white);
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    text-align: center;
    transition: all 0.3s ease;
    cursor: pointer;
    border-top: 4px solid var(--maroon);
}

.neighborhood-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 30px rgba(0,0,0,0.15);
}

.neighborhood-card h4 {
    color: var(--maroon);
    margin-bottom: 10px;
}

.location-count {
    background: var(--maroon);
    color: var(--white);
    padding: 4px 12px;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: bold;
    margin-top: 10px;
    display: inline-block;
}

/* Enhanced Legend */
.map-legend {
    position: absolute;
    bottom: 20px;
    left: 20px;
    background: rgba(255,255,255,0.95);
    padding: 20px;
    border-radius: 15px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    z-index: 1000;
    max-width: 220px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.8);
}

.legend-item {
    cursor: pointer;
    padding: 6px 0;
    transition: all 0.3s ease;
    border-radius: 6px;
    padding-left: 8px;
}

.legend-item:hover {
    background: rgba(116, 38, 79, 0.1);
    transform: translateX(5px);
}

.map-overlay {
    position: absolute;
    top: 20px;
    right: 20px;
    background: rgba(255,255,255,0.9);
    padding: 15px;
    border-radius: 12px;
    z-index: 1000;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.8);
}

/* Responsive Design */
@media (max-width: 768px) {
    .map-container {
        grid-template-columns: 1fr;
    }
    
    .map-wrapper {
        height: 400px;
    }
    
    .hero-stats {
        gap: 15px;
    }
    
    .stat-bubble {
        width: 80px;
        height: 80px;
    }
    
    .stat-number {
        font-size: 1.4rem;
    }
    
    .filter-controls {
        flex-direction: column;
        align-items: center;
    }
    
    .filter-btn {
        width: 200px;
    }
    
    .search-controls {
        flex-direction: column;
        align-items: center;
    }
    
    #locationSearch {
        width: 250px;
    }
    
    .map-legend, .map-overlay {
        position: relative;
        bottom: auto;
        left: auto;
        right: auto;
        margin: 15px;
        max-width: none;
    }
    
    .neighborhoods-grid {
        grid-template-columns: 1fr;
    }
    
    .location-actions {
        flex-direction: column;
    }
}
</style>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
// Enhanced JavaScript with rich information and animations
let map;
let markers = L.layerGroup();
let markerCluster;
let allLocations = [];

// Fun facts for different categories
const funFacts = {
    historical: [
        "Lower Merion was settled by Welsh Quakers in 1682, just one year after William Penn founded Pennsylvania.",
        "The township's name comes from Merionethshire in Wales, honoring the settlers' homeland.",
        "Several locations in Lower Merion played roles in the Revolutionary War, including the General Wayne Inn."
    ],
    shopping: [
        "Suburban Square was one of America's first planned shopping centers, revolutionizing retail in 1928.",
        "The Ardmore Farmers Market has been serving the community for generations with local produce.",
        "Main Line shopping districts blend historic architecture with modern retail experiences."
    ],
    parks: [
        "Lower Merion maintains over 500 acres of parkland and open spaces for public enjoyment.",
        "The Cynwyd Heritage Trail repurposed an old railway into a popular community pathway.",
        "Many parks preserve historic mill sites from the township's early industrial period."
    ],
    education: [
        "Bryn Mawr College was one of the first women's colleges to offer graduate degrees.",
        "Haverford College's arboretum contains over 400 species of trees and shrubs.",
        "The Main Line is home to some of the nation's most prestigious educational institutions."
    ],
    entertainment: [
        "The Bryn Mawr Film Institute preserves the tradition of cinema in a restored 1926 theater.",
        "Ardmore Music Hall has hosted musicians from around the world in an intimate setting.",
        "Cultural venues in Lower Merion blend historic preservation with contemporary arts."
    ],
    community: [
        "Lower Merion has been recognized as one of the best places to live in Pennsylvania.",
        "The township balances historic preservation with modern community services.",
        "Community institutions have served residents for generations, adapting to changing needs."
    ]
};

// Custom icon creation with animations
function createCustomIcon(category) {
    const iconHtml = `
        <div class="custom-marker marker-${category}">
            ${getCategoryIcon(category)}
        </div>
    `;
    
    return L.divIcon({
        html: iconHtml,
        className: 'custom-marker-icon',
        iconSize: [30, 30],
        iconAnchor: [15, 15]
    });
}

// Get appropriate icon for each category
function getCategoryIcon(category) {
    const icons = {
        historical: 'ðŸ›ï¸',
        shopping: 'ðŸ›ï¸',
        parks: 'ðŸŒ³',
        education: 'ðŸŽ“',
        entertainment: 'ðŸŽ­',
        community: 'ðŸ˜ï¸',
        sports: 'âš½',
        food_drink: 'ðŸ½ï¸',
        nature_center: 'ðŸŒ¿',
        recreation: 'ðŸŽ¯'
    };
    return icons[category] || 'ðŸ“';
}

// Initialize the enhanced map
function initMap() {
    // Center on Lower Merion Township with elegant basemap
    map = L.map('map', {
        zoomControl: false,
        fadeAnimation: true,
        zoomAnimation: true
    }).setView([40.00678, -75.295], 13);
    
    // Add elegant basemap
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: 'Â© OpenStreetMap, Â© CartoDB',
        maxZoom: 19,
        subdomains: 'abcd'
    }).addTo(map);
    
    // Add zoom control with better positioning
    L.control.zoom({
        position: 'topright'
    }).addTo(map);
    
    // Initialize marker cluster group with enhanced options
    markerCluster = L.markerClusterGroup({
        chunkedLoading: true,
        maxClusterRadius: 50,
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        zoomToBoundsOnClick: true,
        animate: true,
        animateAddingMarkers: true
    });
    
    map.addLayer(markerCluster);
    
    // Load locations
    loadLocations();
    
    // Add neighborhood click handlers
    document.querySelectorAll('.neighborhood-card').forEach(card => {
        card.addEventListener('click', function() {
            const neighborhood = this.getAttribute('data-neighborhood');
            filterByNeighborhood(neighborhood);
        });
    });
    
    // Add legend click handlers
    document.querySelectorAll('.legend-item').forEach(item => {
        item.addEventListener('click', function() {
            const category = this.getAttribute('data-category');
            filterLocations(category);
            
            // Update active filter button
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.filter-btn[data-filter="${category}"]`).classList.add('active');
        });
    });
}

// Load locations from API
function loadLocations() {
    fetch('/api/locations')
        .then(response => response.json())
        .then(locations => {
            allLocations = locations;
            displayLocations(locations);
            loadFeaturedLocations(locations);
        })
        .catch(error => console.error('Error loading locations:', error));
}

// Display locations on map with enhanced popups
function displayLocations(locations) {
    // Clear existing markers
    markerCluster.clearLayers();
    
    locations.forEach((location, index) => {
        // Create custom marker with staggered animation
        const marker = L.marker([location.lat, location.lng], {
            icon: createCustomIcon(location.category)
        });
        
        // Create enhanced popup content
        const popupContent = createEnhancedPopupContent(location);
        
        marker.bindPopup(popupContent, {
            className: 'enhanced-popup',
            maxWidth: 300
        });
        
        marker.locationData = location;
        
        // Add click handler for sidebar with animation delay
        marker.on('click', function() {
            setTimeout(() => {
                showLocationDetails(location.id);
            }, 300);
        });
        
        // Add to cluster group with staggered animation
        setTimeout(() => {
            markerCluster.addLayer(marker);
        }, index * 50);
    });
}

// Create enhanced popup content
function createEnhancedPopupContent(location) {
    return `
        <div class="popup-content">
            <div class="popup-header">
                <h3>${location.name}</h3>
                <div class="popup-meta">
                    <span class="category-badge ${location.category}">${location.category}</span>
                    <span class="era">${location.era}</span>
                </div>
            </div>
            <div class="popup-body">
                <p>${location.description}</p>
                <div class="popup-neighborhood">
                    <i class="fas fa-map-pin"></i> ${location.neighborhood}
                </div>
            </div>
            <div class="popup-actions">
                <button onclick="showLocationDetails('${location.id}')" class="popup-btn">
                    <i class="fas fa-info-circle"></i> More Details
                </button>
            </div>
        </div>
    `;
}

// Show enhanced location details in sidebar
function showLocationDetails(locationId) {
    const location = allLocations.find(loc => loc.id === locationId);
    if (!location) return;
    
    const detailsElement = document.getElementById('locationDetails');
    const defaultMessage = document.getElementById('defaultMessage');
    
    // Add entrance animation
    detailsElement.style.animation = 'fadeInUp 0.6s ease';
    
    // Update details with enhanced information
    document.getElementById('locationTitle').textContent = location.name;
    document.getElementById('locationDescription').textContent = location.description;
    document.getElementById('locationHistory').textContent = location.history;
    document.getElementById('eraBadge').textContent = location.era;
    document.getElementById('locationSignificance').textContent = location.significance;
    
    // Update category tag
    const categoryTag = document.getElementById('locationCategory');
    categoryTag.textContent = location.category.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
    categoryTag.className = `category-tag ${location.category}`;
    
    // Update neighborhood
    document.getElementById('locationNeighborhood').textContent = location.neighborhood;
    
    // Update "Open in Maps" link
    const mapsLink = document.getElementById('openInMaps');
    mapsLink.href = `https://www.google.com/maps/search/?api=1&query=${location.lat},${location.lng}&query_place_id=${encodeURIComponent(location.name)}`;
    
    // Add random fun fact
    const funFactText = document.getElementById('funFactText');
    const categoryFacts = funFacts[location.category] || funFacts.historical;
    const randomFact = categoryFacts[Math.floor(Math.random() * categoryFacts.length)];
    funFactText.textContent = randomFact;
    
    // Show details, hide default message
    defaultMessage.style.display = 'none';
    detailsElement.style.display = 'block';
    
    // Pan to location with smooth animation
    map.setView([location.lat, location.lng], 15, {
        animate: true,
        duration: 1.5,
        easeLinearity: 0.25
    });
    
    // Open popup for the selected marker
    markerCluster.eachLayer(function(layer) {
        if (layer.locationData && layer.locationData.id === locationId) {
            layer.openPopup();
        }
    });
}

// Filter by neighborhood
function filterByNeighborhood(neighborhood) {
    const filteredLocations = allLocations.filter(loc => 
        loc.neighborhood.toLowerCase().includes(neighborhood.toLowerCase())
    );
    displayLocations(filteredLocations);
    
    // Fit bounds to show all locations in neighborhood
    if (filteredLocations.length > 0) {
        const group = new L.featureGroup(filteredLocations.map(loc => 
            L.marker([loc.lat, loc.lng])
        ));
        map.fitBounds(group.getBounds(), { padding: [20, 20] });
    }
}

// Share location function
function shareLocation() {
    const location = allLocations.find(loc => 
        loc.id === document.getElementById('locationTitle').textContent.toLowerCase().replace(/[^a-z0-9]/g, '-')
    );
    
    if (location && navigator.share) {
        navigator.share({
            title: location.name,
            text: location.description,
            url: window.location.href
        });
    } else {
        // Fallback: copy to clipboard
        const tempInput = document.createElement('input');
        tempInput.value = `${location.name} - ${window.location.href}`;
        document.body.appendChild(tempInput);
        tempInput.select();
        document.execCommand('copy');
        document.body.removeChild(tempInput);
        
        alert('Location link copied to clipboard!');
    }
}

// The rest of the functions remain similar but with enhanced animations
// [Previous filterLocations, searchLocations, resetMap, loadFeaturedLocations functions remain the same]
// but with added animation enhancements

// Initialize everything when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    initMap();
    
    // Add enhanced filter button event listeners
    document.querySelectorAll('.filter-btn').forEach(button => {
        button.addEventListener('click', function() {
            const filter = this.getAttribute('data-filter');
            
            // Update active button with animation
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.style.transform = 'translateY(0)';
            });
            this.classList.add('active');
            this.style.transform = 'translateY(-2px)';
            
            // Apply filter
            filterLocations(filter);
        });
    });
    
    // Add enhanced search input event listener
    document.getElementById('locationSearch').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchLocations();
        }
    });
    
    // Add input event for real-time search with debounce
    let searchTimeout;
    document.getElementById('locationSearch').addEventListener('input', function(e) {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            if (e.target.value.length === 0) {
                displayLocations(allLocations);
            } else if (e.target.value.length >= 2) {
                searchLocations();
            }
        }, 300);
    });
});

// Add CSS animation
const style = document.createElement('style');
style.textContent = `
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .enhanced-popup .leaflet-popup-content-wrapper {
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    .popup-content {
        padding: 5px;
    }
    
    .popup-header {
        margin-bottom: 10px;
    }
    
    .popup-header h3 {
        margin: 0 0 8px 0;
        color: #74264F;
        font-size: 1.1rem;
    }
    
    .popup-meta {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }
    
    .category-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: bold;
        text-transform: uppercase;
    }
    
    .era {
        background: #FFC72C;
        color: #74264F;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: bold;
    }
    
    .popup-neighborhood {
        color: #666;
        font-size: 0.8rem;
        margin-top: 8px;
        display: flex;
        align-items: center;
        gap: 4px;
    }
    
    .popup-btn {
        background: #74264F;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 15px;
        cursor: pointer;
        font-size: 0.8rem;
        width: 100%;
        margin-top: 10px;
        transition: all 0.3s ease;
    }
    
    .popup-btn:hover {
        background: #8B2252;
        transform: translateY(-1px);
    }
`;
document.head.appendChild(style);
</script>

{% endblock %}